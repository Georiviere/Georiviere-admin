!function(){L.Handler.MarkerPin=L.Handler.extend({options:{distance:20,vertices:!0},initialize:function(i,t,e){L.Handler.prototype.initialize.call(this,i),L.Util.setOptions(this,e||{})},enable:function(i){i&&this._map.options.pin&&(this._observeMarker(i),this._currentMarker=i)},disable:function(){this._map.options.pin&&this._unobserveMarker()},_observeMarker:function(i){i.on("move",this._updateLatLng,this)},_unobserveMarker:function(){this._currentMarker.off("move",this._updateLatLng,this)},_updateLatLng:function(i){var t=i.target;t.setOpacity(1),t._shadow||L.DomUtil.addClass(t._icon,"leaflet-marker-icon leaflet-div-icon leaflet-editing-icon leaflet-pin-marker");var e=t.getLatLng();this._closest=this._findClosestMarker(this._map,this._map._guideList,e,this.options.distance,this.options.vertices),this._closestCircle=this._map.options.pinCircle?this._findClosestCircle(this._map,this._map._circleGuideList,i.latlng):null,null!=this._closestCircle?(t._latlng=this._closestCircle,t.update()):null!=this._closest&&(t._latlng=this._closest.latlng,t.update())},_findClosestMarker:function(i,t,e,n,s){return L.GeometryUtil.closestLayerSnap(i,t,e,n,s)},_findClosestCircle:function(i,t,e){var n=L.GeometryUtil.closestLayerSnap(i,t,e);if(null!==n){var s=n.layer.getLatLng().lng-e.lng,a=n.layer.getLatLng().lat-e.lat,o=Math.abs(a)/Math.abs(s),_=Math.atan(o),r=n.layer.editing._shape._radius,l=this._map.project(n.latlng),h=this._map.project(e),p=Math.abs(h.x-l.x),d=Math.abs(h.y-l.y),c=Math.sqrt(Math.pow(p,2)+Math.pow(d,2));if(!(r+this.options.distance>c&&r-this.options.distance<c))return this.options.distance>c?n.layer.getLatLng():null;var u=r*Math.cos(_),g=r*Math.sin(_),f=this._map.project(n.layer.getLatLng());if(s>=0&&a>=0)return this._map.unproject([f.x-u,f.y+g]);if(s>=0&&a<0)return this._map.unproject([f.x-u,f.y-g]);if(s<0&&a<0)return this._map.unproject([f.x+u,f.y-g]);if(s<0&&a>=0)return this._map.unproject([f.x+u,f.y+g])}return null}}),L.Map.Pin={_pin_initialize:function(){this._guideList=[],this._circleGuideList=[];for(var i=0;i<this.options.guideLayers.length;i++)this.addGuideLayer(this.options.guideLayers[i]);this.options.pinControl&&this.addControl(new L.Control.Pin)},togglePin:function(){this.options.pin=!this.options.pin},removeGuideLayer:function(i){for(var t=0;t<this._guideList.length;t++)this._guideList[t]._leaflet_id==i._leaflet_id&&this._guideList.splice(t,1)},_parse:function(i){var t=this;if(i instanceof L.FeatureGroup){i.on("layeradd",function(i){t._parse(i.layer)}),i.on("layerremove",function(i){t.removeGuideLayer(i.layer)});for(var e in i._layers)i._layers.hasOwnProperty(e)&&this._parse(i._layers[e])}else if(i instanceof L.Polygon||i instanceof L.Rectangle){var n=new L.polygon(L.LatLngUtil.cloneLatLngs(i.getLatLngs()));n._leaflet_id=i._leaflet_id,this._guideList.push(n)}else if(i instanceof L.Polyline){var s=new L.polyline(L.LatLngUtil.cloneLatLngs(i.getLatLngs()));s._leaflet_id=i._leaflet_id,this._guideList.push(s)}else if(i instanceof L.Circle){var a=new L.circle(L.LatLngUtil.cloneLatLng(i.getLatLng(),JSON.parse(JSON.stringify(i.getRadius()))));a._mRadius=JSON.parse(JSON.stringify(i.getRadius())),a._leaflet_id=i._leaflet_id,a.editing=i.editing,this._circleGuideList.push(a)}else{var o=new L.marker(L.LatLngUtil.cloneLatLng(i.getLatLng()));o._leaflet_id=i._leaflet_id,this._guideList.push(o)}},updateGuideLayer:function(i,t){for(var e,n=i,s=0;s<this._guideList.length;s++)this._guideList[s]._leaflet_id==n&&(e=this._guideList[s]);if(!e)for(var s=0;s<this._circleGuideList.length;s++)this._circleGuideList[s]._leaflet_id==n&&(e=this._circleGuideList[s]);if(e)for(var s=0;s<this._guideList.length;s++)this._guideList[s]._leaflet_id==i&&(t.length?this._guideList[s].setLatLngs(L.LatLngUtil.cloneLatLngs(t)):this._guideList[s].setLatLng(L.LatLngUtil.cloneLatLng(t)));else{var a=this._layers[i];a&&(a._icon&&!L.DomUtil.hasClass(a._icon,"leaflet-editing-icon")&&this.addGuideLayer(a),a._icon||this.addGuideLayer(a))}},addGuideLayer:function(i){this._parse(i)},deleteGuideLayers:function(i){var t=this._guideList;i instanceof L.Circle&&(t=this._circleGuideList);for(var e=0;e<t.length;e++)t[e]instanceof L.LayerGroup&&t[e].hasLayer(i)?t[e].removeLayer(L.Util.stamp(i)):L.Util.stamp(t[e])===L.Util.stamp(i)&&(i instanceof L.Circle?this._circleGuideList=[].concat(t.slice(0,e),t.slice(e+1)):this._guideList=[].concat(t.slice(0,e),t.slice(e+1)))}},L.Map.include(L.Map.Pin),L.Map.addInitHook("_pin_initialize"),L.Map.mergeOptions({pin:!1,pinCircle:!1,pinControl:!1,guideLayers:[]}),L.Draw.Feature.Pin={_pin_initialize:function(){this.on("enabled",this._pin_on_enabled,this),this.on("disabled",this._pin_on_disabled,this)},_pin_on_enabled:function(){"circle"!=this.type&&"rectangle"!=this.type||(this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:1002}).addTo(this._map),this._map.on("mousemove",this._pin_on_mouse_move,this),this._map.on("mousedown",this._pin_on_mouse_down,this));var i=this._mouseMarker;this._pinning||(this._pinning=new L.Handler.MarkerPin(this._map)),this.options.vertices&&(this._pinning.options.vertices=this.options.vertices),this.options.distance&&(this._pinning.options.distance=this.options.distance),this._pinning.enable(i),i.on("click",this._pin_on_click,this)},_pin_on_mouse_down:function(){this._pinning._closestCircle?this._startLatLng=this._pinning._closestCircle:this._pinning._closest&&(this._startLatLng=this._pinning._closest.latlng)},_pin_on_mouse_move:function(i){var t=i.latlng,e=this._pinning._closest,n=this._pinning._closestCircle;n&&(e=e||{},e.latlng=n),this._shape&&(this._shape instanceof L.Circle?this._shape.setRadius(this._startLatLng.distanceTo(e?e.latlng:t)):this._shape instanceof L.Rectangle&&this._shape.setBounds(new L.LatLngBounds(this._startLatLng,e?e.latlng:t))),this._mouseMarker.setLatLng(t)},_pin_on_click:function(i){if(this._markers){var t=this._markers.length,e=this._markers[t-1];if(i&&(e.setLatLng(i.target._latlng),this._poly)){var n=this._poly._latlngs.length;this._poly._latlngs[n-1]=i.target._latlng,this._poly.redraw()}}},_pin_on_disabled:function(){"circle"!=this.type&&"rectangle"!=this.type||(this._map.off("mousemove",this._pin_on_mouse_move,this),this._map.off("mousedown",this._pin_on_mouse_down,this),this._map.removeLayer(this._mouseMarker)),delete this._pinning}},L.Edit.Marker.Pin={_pin_initialize:function(){this._marker.on("dragstart",this._pin_on_dragstart,this),this._marker.on("dragend",this._pin_on_dragend,this)},_pin_on_dragstart:function(i){this._marker._pinning||(this._marker._pinning=new L.Handler.MarkerPin(this._marker._map)),this._marker._pinning.enable(this._marker),this._marker._map.deleteGuideLayers(this._marker)},_pin_on_dragend:function(i){this._marker._pinning.disable(this._marker),this._marker._map.updateGuideLayer(this._marker._leaflet_id,this._marker.getLatLng()),delete this._marker._pinning}},L.Edit.Marker.include(L.Edit.Marker.Pin),L.Edit.Marker.addInitHook("_pin_initialize"),L.Draw.Feature.include(L.Draw.Feature.Pin),L.Draw.Feature.addInitHook("_pin_initialize"),L.Edit.Poly.Pin={_pin_initialize:function(){this._poly.on("edit",this._poly_edit,this),this._poly.on("editstart",this._poly_edit_start,this)},_poly_check_self:function(){this._poly._map.deleteGuideLayers(this._poly)},_poly_edit:function(){this._poly._map.updateGuideLayer(this._poly._leaflet_id,this._poly.getLatLngs())}},L.Edit.Poly.include(L.Edit.Poly.Pin),L.Edit.Poly.addInitHook("_pin_initialize"),L.Edit.SimpleShape.Pin={_pin_initialize:function(){this._shape.on("edit",this._shape_edit_start,this)},_shape_edit_start:function(){this._map.updateGuideLayer(this._shape._leaflet_id,this._shape.getLatLngs())}},L.Edit.SimpleShape.include(L.Edit.SimpleShape.Pin),L.Edit.SimpleShape.addInitHook("_pin_initialize"),L.Control.Pin=L.Control.extend({options:{position:"topleft"},onAdd:function(i){return this._container=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-pin"),this._container.id="leaflet-pin-button",this._createButton(),this._updateButton(),this._container},_createButton:function(){var i=L.DomUtil.create("a","",this._container);L.DomEvent.on(i,"click",this._togglePin,this)},_togglePin:function(){this._map.togglePin(),this._updateButton()},_updateButton:function(){var i="leaflet-control-pin-enabled";this._map.options.pin?L.DomUtil.addClass(this._container,i):L.DomUtil.removeClass(this._container,i)}})}();